<% partial("app/layouts/_admin_header.jl.html") %>

<div class="container">
    <div class="row text-center">
        <h1>Manage User: $(params(:username))</h1>
    </div>

    <div>
        <!-- TODO: Check if action and method are necessary here -->
        <form class="d-flex align-items-center justify-content-center mt-3" id="add-form" action="/add" method="post">
            <label class="my-1 me-2">Add experiment:</label>
            <select name="experiment" class="form-select my-1 me-sm-2 w-auto" id="add-experiment">
                <option value="default" selected>Choose here</option>
                <%  for_each(experiments) do e 
                        if e.name in getproperty.(unstarted_experiments, :experiment_name)
                %>
                            <option value="$(e.name)" disabled>$(e.name)</option>
                        <% else %>
                            <option value="$(e.name)">$(e.name)</option>
                        <% end %>
                <% end %>
            </select>
            <input type="hidden" name="user_id" value="$(user_id)">
            <input id="add-submit" class="btn btn-primary" type="submit" value="Add" disabled>
        </form>
    </div>

    <div class="row d-flex justify-content-center">
        <div class="col-md-auto">
            <!-- TODO: Add sort feature -->
            <table class="styled-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Instance</th>
                        <th>Percent complete</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="userexperiment-tbody">
                <% for_each(added_experiments) do e 
                    counter += 1 %>
                    <tr>
                        <td>$(e.experiment_name)</td>
                        <td>$(e.instance)</td>
                        <td>$(round(Int, 100*e.trials_complete / n_trials[counter]))&percnt;</td>
                        <%  if e.trials_complete == 0  %>
                            <td>
                                <form style="float:left;" name="remove-form" method="post">
                                    <input type="hidden" name="name" value="$(e.experiment_name)">
                                    <input type="hidden" name="instance" value="$(e.instance)">
                                    <input type="hidden" name="user_id" value="$(user_id)">
                                    <input type="submit" value="Remove"></input>
                                </form>
                            </td>
                        <%  elseif !(
                                e.experiment_name in getproperty.(unstarted_experiments, :experiment_name)
                            ) && e.trials_complete < n_trials[counter]
                        %>
                                <td> 
                                    <form style="float:left;" name="restart-form">
                                        <input type="hidden" name="name" value="$(e.experiment_name)">
                                        <input type="hidden" name="instance" value="$(e.instance)">
                                        <input type="hidden" name="user_id" value="$(user_id)">
                                        <input type="submit" value="Restart"></input>
                                    </form>
                                </td>
                        <%  else  %>
                            <td>None</td>
                        <%  end  %>
                    </tr>
                <% end %>
                </tbody>
            </table>
        </div>
    </div>

</div>

<div aria-live="polite" aria-atomic="true" class="toast-container p-3 bottom-0 start-50 translate-middle-x">
    <div id="Toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Info</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

<script>
    ready(showToast)

    // Post add or remove request
    document.addEventListener("submit", function(e) {
        if (e.target.getAttribute("id") == "add-form") { // using id because only ever one
            e.preventDefault();
            addExperiment(e.target);
        } else if (e.target.getAttribute("name") == "restart-form") { // using name because could be multiple (rows)
            e.preventDefault();
            const ans = confirm("Are you sure you want to restart this experiment? This action cannot be undone.");
            if (ans) {
                restartExperiment(e.target);
            }
        } else if (e.target.getAttribute("name") == "remove-form") { // using name because could be multiple (rows)
            e.preventDefault();
            const ans = confirm("Are you sure you want to remove this experiment?");
            if (ans) {
                removeExperiment(e.target);
            }
        }
    });

    const select = document.getElementById("add-experiment");
    const submitButton = document.getElementById("add-submit");
    // Disable add button if default is selected
    select.addEventListener("change", () => {
        if (select.value === "default") {
            submitButton.disabled = true;
        } else {
            submitButton.disabled = false;
        }
    });
</script>
